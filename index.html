<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Lexicon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #e3e4e8;
            --bg-secondary: #f5f6f8;
            --bg-card: #ffffff;
            --text-primary: #1c1c1e;
            --text-secondary: #898a8f;
            --text-tertiary: #a9aaaf;
            --divider: #d0d1d6;
            --hover: #ecedf2;
            --selected: #e0e1e6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(210, 180, 230, 0.6) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(180, 210, 245, 0.5) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 70%, rgba(245, 190, 180, 0.45) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(230, 215, 190, 0.5) 0%, transparent 50%),
                linear-gradient(180deg, #e0e1e6 0%, #d4d5da 100%);
            color: var(--text-primary);
            font-size: 10px;
            line-height: 1.47;
            letter-spacing: -0.016em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }

        .header {
            background: transparent;
            position: relative;
            z-index: 100;
        }

        .header-top {
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 32px;
            border-bottom: 1px solid var(--divider);
        }

        .logo {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.024em;
            color: var(--text-primary);
        }

        .header-stats {
            display: flex;
            gap: 28px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            margin-left: 7px;
        }

        .universal-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px 18px;
            background: transparent;
        }

        .search-container {
            flex: 1;
            position: relative;
            max-width: 440px;
        }

        .universal-search {
            width: 100%;
            padding: 9px 16px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            font-family: inherit;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .universal-search:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.65);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .universal-search::placeholder {
            color: var(--text-tertiary);
        }

        .sort-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .sort-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .universal-sort-btn {
            padding: 7px 16px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            border-radius: 10px;
        }

        .universal-sort-btn:hover {
            background: rgba(255, 255, 255, 0.65);
            color: var(--text-primary);
        }

        .universal-sort-btn.active {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(255, 255, 255, 0.4);
            color: var(--text-primary);
        }

        .columns-container {
            display: flex;
            height: calc(100vh - 56px - 54px);
            overflow: hidden;
            gap: 1px;
            background: transparent;
            padding: 0;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.28, 0.11, 0.32, 1);
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.25);
        }

        .column:last-child {
            border-right: none;
        }

        .column.collapsed {
            flex: 0 0 32px;
            min-width: 32px;
        }

        .column.expanded {
            flex: 1 1 auto;
            min-width: 600px;
        }

        .column-header {
            padding: 18px 16px;
            background: transparent;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .column-header:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .column.collapsed .column-header {
            writing-mode: vertical-lr;
            text-align: center;
            padding: 24px 10px;
        }

        .column-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: -0.015em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .column.active .column-title {
            color: var(--text-primary);
        }

        .column.collapsed .column-title {
            margin-bottom: 0;
        }

        .column-count {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .column.active .column-count {
            color: var(--text-secondary);
        }

        .column.collapsed .column-count {
            display: none;
        }

        .column.collapsed .items-list {
            display: none;
        }

        .items-list {
            flex: 1;
            overflow-y: auto;
            background: transparent;
        }

        .loading-indicator {
            padding: 20px;
            text-align: center;
            color: var(--gray-400);
            font-size: 8px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 4px 12px;
            cursor: pointer;
            position: relative;
        }

        .item-inner {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            padding: 7px 12px;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .item:hover .item-inner {
            background: rgba(0, 0, 0, 0.05);
        }

        .item.active .item-inner {
            background: var(--selected);
        }

        .item-text {
            font-size: 12px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 400;
            color: var(--text-primary);
            flex: 1;
        }

        .item.active .item-text {
            font-weight: 500;
        }

        .item-count {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            margin-left: auto;
        }

        .item.active .item-count {
            color: var(--text-secondary);
        }


        .dreams-view {
            flex: 1;
            overflow-y: auto;
            padding: 32px 40px;
            display: none;
            background: transparent;
        }

        .column.expanded .dreams-view {
            display: block;
        }

        .column.expanded .items-list {
            display: none;
        }

        .dreams-header {
            margin-bottom: 36px;
            padding-bottom: 22px;
            border-bottom: 1px solid var(--divider);
        }

        .selected-phrase {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.028em;
            margin-bottom: 12px;
            line-height: 1.15;
            color: var(--text-primary);
        }

        .dreams-meta {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .dream-card {
            margin-bottom: 28px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .dream-card:last-child {
            margin-bottom: 0;
        }

        .dream-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .dream-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .dream-id {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        .dream-text {
            font-size: 14px;
            line-height: 1.55;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .highlight {
            background: linear-gradient(120deg, rgba(210, 180, 230, 0.4), rgba(180, 210, 245, 0.4));
            color: var(--text-primary);
            font-weight: 500;
            padding: 2px 4px;
            border-radius: 4px;
        }

        mark {
            background: rgba(142, 142, 147, 0.1);
            padding: 0 3px;
            border-radius: 3px;
        }

        .back-button {
            display: inline-block;
            margin-bottom: 24px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            text-transform: lowercase;
        }

        .back-button:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.65);
        }

        .poetry-btn {
            margin-left: auto;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            text-transform: lowercase;
        }

        .poetry-btn:hover {
            background: linear-gradient(120deg, rgba(210, 180, 230, 0.6), rgba(180, 210, 245, 0.6));
            border-color: rgba(210, 190, 235, 0.4);
            color: var(--text-primary);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                180deg, 
                rgba(232, 233, 237, 0.95) 0%, 
                rgba(223, 224, 229, 0.95) 100%
            );
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(120deg, rgba(210, 180, 230, 0.8), rgba(180, 210, 245, 0.8));
            animation: pulse 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 24px;
        }

        .loading-stats {
            display: flex;
            gap: 48px;
        }

        .loading-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .loading-stat-value {
            font-size: 32px;
            font-weight: 600;
            background: linear-gradient(120deg, rgba(210, 180, 230, 1), rgba(180, 210, 245, 1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-variant-numeric: tabular-nums;
        }

        .loading-stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 32px;
        }

        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, rgba(210, 180, 230, 0.9), rgba(180, 210, 245, 0.9));
            border-radius: 2px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
            }
        }

        .load-more-btn {
            padding: 10px 16px;
            margin: 16px;
            font-size: 8px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: 1px solid var(--gray-700);
            background: var(--white);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
            width: calc(100% - 32px);
        }

        .load-more-btn:hover {
            background: var(--black);
            color: var(--white);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <div class="loading-text">loading dream lexicon...</div>
        <div class="loading-stats">
            <div class="loading-stat">
                <span class="loading-stat-value" id="loadingPatterns">0</span>
                <span class="loading-stat-label">patterns loaded</span>
            </div>
            <div class="loading-stat">
                <span class="loading-stat-value" id="loadingDreams">0</span>
                <span class="loading-stat-label">dreams indexed</span>
            </div>
        </div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
    </div>
    
    <div class="header">
        <div class="header-top">
            <div class="logo">Dream Lexicon</div>
            <div class="header-stats">
                <span>patterns <span class="stat-value" id="total-patterns">—</span></span>
                <span>dreams <span class="stat-value" id="total-dreams">—</span></span>
            </div>
            <a href="poetry.html" class="poetry-btn">make your own fridge poetry</a>
        </div>
        <div class="universal-controls">
            <div class="search-container">
                <input type="text" class="universal-search" placeholder="Search all patterns..." id="universal-search">
            </div>
            <div class="sort-controls">
                <span class="sort-label">Sort</span>
                <button class="universal-sort-btn active" data-sort="alpha">A–Z</button>
                <button class="universal-sort-btn" data-sort="freq">Frequency</button>
            </div>
        </div>
    </div>

    <div class="columns-container">
        <div class="column" data-pattern="adj_noun">
            <div class="column-header">
                <div class="column-title">Adj–Noun</div>
                <div class="column-count" id="count-adj_noun">—</div>
            </div>
            <div class="items-list" id="list-adj_noun"></div>
            <div class="dreams-view" id="dreams-adj_noun"></div>
        </div>

        <div class="column" data-pattern="verb_noun">
            <div class="column-header">
                <div class="column-title">Verb–Noun</div>
                <div class="column-count" id="count-verb_noun">—</div>
            </div>
            <div class="items-list" id="list-verb_noun"></div>
            <div class="dreams-view" id="dreams-verb_noun"></div>
        </div>

        <div class="column" data-pattern="prep">
            <div class="column-header">
                <div class="column-title">Prepositional</div>
                <div class="column-count" id="count-prep">—</div>
            </div>
            <div class="items-list" id="list-prep"></div>
            <div class="dreams-view" id="dreams-prep"></div>
        </div>

        <div class="column" data-pattern="adverb_verb">
            <div class="column-header">
                <div class="column-title">Adverb–Verb</div>
                <div class="column-count" id="count-adverb_verb">—</div>
            </div>
            <div class="items-list" id="list-adverb_verb"></div>
            <div class="dreams-view" id="dreams-adverb_verb"></div>
        </div>

        <div class="column" data-pattern="temporal">
            <div class="column-header">
                <div class="column-title">Temporal</div>
                <div class="column-count" id="count-temporal">—</div>
            </div>
            <div class="items-list" id="list-temporal"></div>
            <div class="dreams-view" id="dreams-temporal"></div>
        </div>

        <div class="column" data-pattern="compound">
            <div class="column-header">
                <div class="column-title">Compound</div>
                <div class="column-count" id="count-compound">—</div>
            </div>
            <div class="items-list" id="list-compound"></div>
            <div class="dreams-view" id="dreams-compound"></div>
        </div>

        <div class="column" data-pattern="emotional">
            <div class="column-header">
                <div class="column-title">Emotional</div>
                <div class="column-count" id="count-emotional">—</div>
            </div>
            <div class="items-list" id="list-emotional"></div>
            <div class="dreams-view" id="dreams-emotional"></div>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ======= CONFIGURATION =======
        // Replace these with your Supabase project credentials
        const SUPABASE_URL = 'https://ldpxwjzqaraehwvybiqe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkcHh3anpxYXJhZWh3dnliaXFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODEwMDAsImV4cCI6MjA4MDM1NzAwMH0.9N7ml2HWY0I3KZ4PEGoyCqnMKRJGzYUcX6g_HuBwIgU';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ======= STATE =======
        const ITEMS_PER_PAGE = 5000; // Load in chunks for infinite scroll
        let universalSort = 'alpha';
        let universalSearch = '';
        
        let loadingStats = {
            actualPatterns: 0,
            actualDreams: 0,
            columnsLoaded: 0,
            totalColumns: 7,
            animationComplete: false,
            dataLoaded: false
        };

        function startLoadingAnimation(estimatedPatterns, estimatedDreams, duration = 3000) {
            const startTime = performance.now();
            
            const patternsEl = document.getElementById('loadingPatterns');
            const dreamsEl = document.getElementById('loadingDreams');
            const progressBar = document.getElementById('loadingProgressBar');
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutCubic(progress);
                
                // Animate patterns count
                if (patternsEl) {
                    const currentPatterns = Math.floor(estimatedPatterns * easedProgress);
                    patternsEl.textContent = currentPatterns.toLocaleString();
                }
                
                // Animate dreams count
                if (dreamsEl) {
                    const currentDreams = Math.floor(estimatedDreams * easedProgress);
                    dreamsEl.textContent = currentDreams.toLocaleString();
                }
                
                // Animate progress bar
                if (progressBar) {
                    progressBar.style.width = (easedProgress * 100) + '%';
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    loadingStats.animationComplete = true;
                    checkLoadingComplete();
                }
            }
            
            requestAnimationFrame(animate);
        }

        function checkLoadingComplete() {
            if (loadingStats.animationComplete) {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }
        }

        function updateActualLoadingStats(patterns) {
            loadingStats.actualPatterns += patterns;
            loadingStats.columnsLoaded++;
        }

        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        function animateNumber(element, start, end, duration) {
            const startTime = performance.now();
            const diff = end - start;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutCubic(progress);
                const current = Math.floor(start + diff * easedProgress);
                element.textContent = current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.textContent = end.toLocaleString();
                }
            }
            
            requestAnimationFrame(update);
        }
        
        let columnData = {
            adj_noun: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            verb_noun: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            prep: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            adverb_verb: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            temporal: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            compound: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            emotional: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 }
        };

        // ======= SUPABASE QUERIES =======
        async function getTotalDreamsCount() {
            const { count, error } = await supabase
                .from('dreams')
                .select('*', { count: 'exact', head: true });
            
            if (error) {
                console.error('Error fetching dreams count:', error);
                return 0;
            }
            return count;
        }

        async function getPatternsByType(patternType, sortBy = 'alpha', searchQuery = '') {
            // Use the fast pattern_counts materialized view
            // Aggregate as we load to avoid stack overflow
            const aggregated = new Map();
            let page = 0;
            const pageSize = 1000;
            const maxPages = 100; // Reasonable limit (100K rows max)
            let totalRows = 0;
            
            while (page < maxPages) {
                try {
                    let query = supabase
                        .from('pattern_counts')
                        .select('text_lower, display_text, count')
                    .eq('pattern_type', patternType)
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                    const { data, error } = await query;
                    
                if (error) {
                        console.error(`Error fetching ${patternType} page ${page}:`, error);
                        if (page === 0) throw error;
                    break;
                }
                
                if (!data || data.length === 0) break;
                    
                    // Process and aggregate immediately to avoid memory issues
            data.forEach(row => {
                        const text = row.text_lower;
                // Skip if starts with number or dash
                if (/^[0-9-]/.test(text)) return;
                // Skip if doesn't match search
                if (searchQuery && !text.includes(searchQuery.toLowerCase())) return;
                
                        if (aggregated.has(text)) {
                            aggregated.get(text).count += row.count;
                        } else {
                            aggregated.set(text, {
                                text: row.display_text,
                                count: row.count
                            });
                        }
                    });
                    
                    totalRows += data.length;
                    if (data.length < pageSize) break;
                    page++;
                } catch (err) {
                    console.error(`Exception loading ${patternType} page ${page}:`, err);
                    if (page === 0) throw err;
                    break;
                }
            }
            
            if (aggregated.size === 0) {
                console.warn('No data fetched for pattern type:', patternType);
                return { results: [], total: 0 };
            }
            
            // Convert to array
            let results = Array.from(aggregated.values());
            
            // Sort
            if (sortBy === 'freq') {
                results.sort((a, b) => b.count - a.count || a.text.localeCompare(b.text));
            } else {
                results.sort((a, b) => a.text.localeCompare(b.text));
            }
            
            const total = results.length;
            
            // Return all results
            return { results: results, total };
        }

        async function getTotalPatternCount(patternType) {
            // Query patterns table directly
            const { data, error } = await supabase
                .from('patterns')
                .select('text', { count: 'exact', head: false })
                .eq('pattern_type', patternType);
            
            if (error) {
                console.error('Error fetching pattern count:', error);
                return 0;
            }
            
            // Count unique texts
            const uniqueTexts = new Set(data.map(p => p.text));
            return uniqueTexts.size;
        }

        async function getDreamsByPattern(patternType, phrase, limit = 100) {
            const { data, error } = await supabase
                .from('patterns')
                .select(`
                    dream_id,
                    start_pos,
                    end_pos,
                    dreams (
                        id,
                        text
                    )
                `)
                .eq('pattern_type', patternType)
                .ilike('text', phrase)
                .limit(limit);
            
            if (error) {
                console.error('Error fetching dreams:', error);
                return [];
            }
            
            // Transform to expected format
            return data.map(row => ({
                id: row.dreams.id,
                text: row.dreams.text,
                start_pos: row.start_pos,
                end_pos: row.end_pos
            }));
        }

        // ======= RENDERING =======
        async function loadColumn(pattern, append = false) {
            const listEl = document.getElementById(`list-${pattern}`);
            
            if (!append) {
                listEl.innerHTML = '<div class="loading-indicator">Loading patterns...</div>';
                columnData[pattern].offset = 0;
                columnData[pattern].patterns = [];
                columnData[pattern].hasMore = true;
            }
            
            try {
                const { results, total } = await getPatternsByType(
                    pattern, 
                    universalSort, 
                    universalSearch, 
                    ITEMS_PER_PAGE, 
                    columnData[pattern].offset
                );
                
                columnData[pattern].patterns.push(...results);
                columnData[pattern].offset += results.length;
                columnData[pattern].hasMore = results.length === ITEMS_PER_PAGE;
                columnData[pattern].loaded = true;
                columnData[pattern].loading = false;
                columnData[pattern].total = total;
                
                renderPatternList(pattern, columnData[pattern].patterns, append);
                
                // Update count with total filtered count
                document.getElementById(`count-${pattern}`).textContent = total.toLocaleString();
                
                // Update loading stats during initial load
                if (!append && document.getElementById('loadingOverlay') && !document.getElementById('loadingOverlay').classList.contains('hidden')) {
                    updateActualLoadingStats(total);
                }
            } catch (error) {
                console.error(`Error loading column ${pattern}:`, error);
                console.error('Error details:', error.message, error.stack);
                listEl.innerHTML = `<div class="loading-indicator">Error loading patterns: ${error.message || 'Unknown error'}</div>`;
            }
        }

        function renderPatternList(pattern, patterns, append = false) {
            const listEl = document.getElementById(`list-${pattern}`);
            
            if (!append) {
                listEl.innerHTML = '';
                
                // Set up scroll listener once
                if (!listEl._scrollHandler) {
                    listEl._scrollHandler = () => {
                        const scrollBottom = listEl.scrollTop + listEl.clientHeight;
                        const threshold = listEl.scrollHeight - 100;
                        
                        if (scrollBottom >= threshold && columnData[pattern].hasMore && !columnData[pattern].loading) {
                            columnData[pattern].loading = true;
                            
                            // Load more from already-fetched data
                            setTimeout(() => {
                                loadColumn(pattern, true);
                            }, 100);
                        }
                    };
                    listEl.addEventListener('scroll', listEl._scrollHandler);
                }
            } else {
                // Remove the old load more button
                const oldBtn = listEl.querySelector('button');
                if (oldBtn) oldBtn.remove();
            }
            
            // Determine which patterns to render
            const startIdx = append ? columnData[pattern].lastRendered || 0 : 0;
            const patternsToRender = patterns.slice(startIdx);
            
            patternsToRender.forEach(({ text, count }) => {
                const div = document.createElement('div');
                div.className = 'item';
                
                const innerDiv = document.createElement('div');
                innerDiv.className = 'item-inner';
                
                const textEl = document.createElement('div');
                textEl.className = 'item-text';
                textEl.textContent = text;
                
                const countEl = document.createElement('div');
                countEl.className = 'item-count';
                countEl.textContent = count;
                
                innerDiv.appendChild(textEl);
                innerDiv.appendChild(countEl);
                
                div.appendChild(innerDiv);
                
                div.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const anyExpanded = document.querySelector('.column.expanded');
                    if (anyExpanded) {
                        collapseAll();
                        setTimeout(() => expandColumn(pattern, text), 50);
                    } else {
                        expandColumn(pattern, text);
                    }
                });
                
                listEl.appendChild(div);
            });
            
            columnData[pattern].lastRendered = patterns.length;
            columnData[pattern].hasMore = false; // All patterns are loaded now
        }

        async function loadAllColumns() {
            const patterns = ['adj_noun', 'verb_noun', 'prep', 'adverb_verb', 'temporal', 'compound', 'emotional'];
            
            // Start animation immediately with estimates
            let estimatedPatterns = 306942;
            let estimatedDreams = 38194;
            
            // Start smooth animation right away
            startLoadingAnimation(estimatedPatterns, estimatedDreams, 4000);
            
            // Set the pattern count in header (hardcoded - actual count from database)
            document.getElementById('total-patterns').textContent = estimatedPatterns.toLocaleString();
            
            // Fetch dream count (non-blocking)
            supabase
                .from('dreams')
                .select('*', { count: 'exact', head: true })
                .then(({ count }) => {
                    if (count) {
                        document.getElementById('total-dreams').textContent = count.toLocaleString();
                    }
                })
                .catch(err => console.error('Error fetching dream count:', err));
            
            // Load all columns
            await Promise.all(patterns.map(p => loadColumn(p)));
            
            // Mark data as loaded
            loadingStats.dataLoaded = true;
            checkLoadingComplete();
        }

        function collapseAll() {
            const columns = document.querySelectorAll('.column');
            columns.forEach(col => {
                col.classList.remove('expanded', 'collapsed', 'active');
            });
        }

        async function expandColumn(pattern, selectedItem) {
            const columns = document.querySelectorAll('.column');
            const selectedColumn = document.querySelector(`.column[data-pattern="${pattern}"]`);
            
            columns.forEach(col => {
                col.classList.remove('expanded', 'active');
                col.classList.add('collapsed');
            });
            
            selectedColumn.classList.remove('collapsed');
            selectedColumn.classList.add('expanded', 'active');
            
            await displayDreams(pattern, selectedItem);
        }

        async function displayDreams(pattern, phrase) {
            const viewEl = document.getElementById(`dreams-${pattern}`);
            viewEl.innerHTML = '<div class="loading-indicator">Loading dreams...</div>';
            
            try {
                const dreams = await getDreamsByPattern(pattern, phrase);
                
                let html = `
                    <div class="back-button" onclick="collapseAll()">← back to all columns</div>
                    <div class="dreams-header">
                        <div class="selected-phrase">${escapeHtml(phrase)}</div>
                        <div class="dreams-meta">${dreams.length} DREAM${dreams.length !== 1 ? 'S' : ''}</div>
                    </div>
                `;
                
                dreams.forEach(dream => {
                    const highlighted = highlightPhrase(dream.text, phrase);
                    html += `
                        <div class="dream-card">
                            <div class="dream-card-header">
                                <span class="dream-label">Dream</span>
                                <span class="dream-id">#${(dream.id + 1).toString().padStart(5, '0')}</span>
                            </div>
                            <div class="dream-text">${highlighted}</div>
                        </div>
                    `;
                });
                
                viewEl.innerHTML = html;
                viewEl.scrollTop = 0;
            } catch (error) {
                console.error('Error displaying dreams:', error);
                viewEl.innerHTML = '<div class="loading-indicator">Error loading dreams</div>';
            }
        }

        function highlightPhrase(text, phrase) {
            const escaped = escapeHtml(text);
            const lower = text.toLowerCase();
            const lowerPhrase = phrase.toLowerCase();
            const parts = [];
            let lastIdx = 0;
            let idx = lower.indexOf(lowerPhrase);
            
            while (idx !== -1) {
                if (idx > lastIdx) parts.push(escaped.substring(lastIdx, idx));
                const match = text.substring(idx, idx + phrase.length);
                parts.push(`<span class="highlight">${escapeHtml(match)}</span>`);
                lastIdx = idx + phrase.length;
                idx = lower.indexOf(lowerPhrase, lastIdx);
            }
            
            if (lastIdx < escaped.length) parts.push(escaped.substring(lastIdx));
            return parts.join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ======= EVENT HANDLERS =======
        document.querySelectorAll('.column-header').forEach(header => {
            header.addEventListener('click', function(e) {
                const anyExpanded = document.querySelector('.column.expanded');
                if (anyExpanded) {
                    collapseAll();
                }
            });
        });

        document.getElementById('universal-search').addEventListener('input', function(e) {
            const anyExpanded = document.querySelector('.column.expanded');
            if (anyExpanded) {
                collapseAll();
            }
            universalSearch = e.target.value;
            // Reload all columns with search
            Object.keys(columnData).forEach(pattern => {
                columnData[pattern].loaded = false;
                columnData[pattern].offset = 0;
                columnData[pattern].patterns = [];
                columnData[pattern].hasMore = true;
            });
            loadAllColumns();
        });

        document.querySelectorAll('.universal-sort-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const anyExpanded = document.querySelector('.column.expanded');
                if (anyExpanded) {
                    collapseAll();
                }
                universalSort = this.dataset.sort;
                document.querySelectorAll('.universal-sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                // Reload all columns with new sort
                Object.keys(columnData).forEach(pattern => {
                    columnData[pattern].loaded = false;
                    columnData[pattern].offset = 0;
                    columnData[pattern].patterns = [];
                    columnData[pattern].hasMore = true;
                });
                loadAllColumns();
            });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                collapseAll();
            }
        });

        // ======= INITIALIZATION =======
        async function init() {
            // Check if Supabase is configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                alert('Please configure your Supabase credentials in the HTML file. See the README for instructions.');
                return;
            }
            
            // Load all columns (this will set the counts)
            await loadAllColumns();
        }

        // Start the app
        init().catch(error => {
            console.error('Error initializing app:', error);
            alert('Error connecting to database. Please check your Supabase configuration and console for details.');
        });
    </script>
</body>
</html>

