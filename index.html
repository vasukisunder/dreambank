<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Lexicon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #e3e4e8;
            --bg-secondary: #f5f6f8;
            --bg-card: #ffffff;
            --text-primary: #1c1c1e;
            --text-secondary: #898a8f;
            --text-tertiary: #a9aaaf;
            --divider: #d0d1d6;
            --hover: #ecedf2;
            --selected: #e0e1e6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(210, 180, 230, 0.6) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(180, 210, 245, 0.5) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 70%, rgba(245, 190, 180, 0.45) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(230, 215, 190, 0.5) 0%, transparent 50%),
                linear-gradient(180deg, #e0e1e6 0%, #d4d5da 100%);
            color: var(--text-primary);
            font-size: 10px;
            line-height: 1.47;
            letter-spacing: -0.016em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }

        .header {
            background: transparent;
            position: relative;
            z-index: 100;
        }

        .header-top {
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 32px;
            border-bottom: 1px solid var(--divider);
        }

        .logo {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.024em;
            color: var(--text-primary);
        }

        .header-stats {
            display: flex;
            gap: 28px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            margin-left: 7px;
        }

        .universal-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px 18px;
            background: transparent;
        }

        .search-container {
            flex: 1;
            position: relative;
            max-width: 440px;
        }

        .universal-search {
            width: 100%;
            padding: 9px 16px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            font-family: inherit;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .universal-search:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.65);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .universal-search::placeholder {
            color: var(--text-tertiary);
        }

        .sort-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .sort-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .universal-sort-btn {
            padding: 7px 16px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            border-radius: 10px;
        }

        .universal-sort-btn:hover {
            background: rgba(255, 255, 255, 0.65);
            color: var(--text-primary);
        }

        .universal-sort-btn.active {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(255, 255, 255, 0.4);
            color: var(--text-primary);
        }

        .columns-container {
            display: flex;
            height: calc(100vh - 56px - 54px);
            overflow: hidden;
            gap: 1px;
            background: transparent;
            padding: 0;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.28, 0.11, 0.32, 1);
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.25);
        }

        .column:last-child {
            border-right: none;
        }

        .column.collapsed {
            flex: 0 0 32px;
            min-width: 32px;
        }

        .column.expanded {
            flex: 1 1 auto;
            min-width: 600px;
        }

        .column-header {
            padding: 18px 16px;
            background: transparent;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .column-header:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .column.collapsed .column-header {
            writing-mode: vertical-lr;
            text-align: center;
            padding: 24px 10px;
        }

        .column-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: -0.015em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .column.active .column-title {
            color: var(--text-primary);
        }

        .column.collapsed .column-title {
            margin-bottom: 0;
        }

        .column-count {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .column.active .column-count {
            color: var(--text-secondary);
        }

        .column.collapsed .column-count {
            display: none;
        }

        .column.collapsed .items-list {
            display: none;
        }

        .items-list {
            flex: 1;
            overflow-y: auto;
            background: transparent;
        }

        .loading-indicator {
            padding: 20px;
            text-align: center;
            color: var(--gray-400);
            font-size: 8px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 4px 12px;
            cursor: pointer;
            position: relative;
        }

        .item-inner {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            padding: 7px 12px;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .item:hover .item-inner {
            background: rgba(0, 0, 0, 0.05);
        }

        .item.active .item-inner {
            background: var(--selected);
        }

        .item-text {
            font-size: 12px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 400;
            color: var(--text-primary);
            flex: 1;
        }

        .item.active .item-text {
            font-weight: 500;
        }

        .item-count {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            margin-left: auto;
        }

        .item.active .item-count {
            color: var(--text-secondary);
        }


        .dreams-view {
            flex: 1;
            overflow-y: auto;
            padding: 32px 40px;
            display: none;
            background: transparent;
        }

        .column.expanded .dreams-view {
            display: block;
        }

        .column.expanded .items-list {
            display: none;
        }

        .dreams-header {
            margin-bottom: 36px;
            padding-bottom: 22px;
            border-bottom: 1px solid var(--divider);
        }

        .selected-phrase {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.028em;
            margin-bottom: 12px;
            line-height: 1.15;
            color: var(--text-primary);
        }

        .dreams-meta {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .dream-card {
            margin-bottom: 28px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .dream-card:last-child {
            margin-bottom: 0;
        }

        .dream-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .dream-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .dream-id {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        .dream-text {
            font-size: 14px;
            line-height: 1.55;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .highlight {
            background: linear-gradient(120deg, rgba(210, 180, 230, 0.4), rgba(180, 210, 245, 0.4));
            color: var(--text-primary);
            font-weight: 500;
            padding: 2px 4px;
            border-radius: 4px;
        }

        mark {
            background: rgba(142, 142, 147, 0.1);
            padding: 0 3px;
            border-radius: 3px;
        }

        .back-button {
            display: inline-block;
            margin-bottom: 24px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            text-transform: lowercase;
        }

        .back-button:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.65);
        }

        .poetry-btn {
            margin-left: auto;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            text-transform: lowercase;
        }

        .poetry-btn:hover {
            background: linear-gradient(120deg, rgba(210, 180, 230, 0.6), rgba(180, 210, 245, 0.6));
            border-color: rgba(210, 190, 235, 0.4);
            color: var(--text-primary);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                180deg, 
                rgba(232, 233, 237, 0.95) 0%, 
                rgba(223, 224, 229, 0.95) 100%
            );
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(120deg, rgba(210, 180, 230, 0.8), rgba(180, 210, 245, 0.8));
            animation: pulse 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 24px;
        }

        .loading-stats {
            display: flex;
            gap: 48px;
        }

        .loading-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .loading-stat-value {
            font-size: 32px;
            font-weight: 600;
            background: linear-gradient(120deg, rgba(210, 180, 230, 1), rgba(180, 210, 245, 1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-variant-numeric: tabular-nums;
        }

        .loading-stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 32px;
        }

        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, rgba(210, 180, 230, 0.9), rgba(180, 210, 245, 0.9));
            border-radius: 2px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
            }
        }

        .load-more-btn {
            padding: 10px 16px;
            margin: 16px;
            font-size: 8px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: 1px solid var(--gray-700);
            background: var(--white);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
            width: calc(100% - 32px);
        }

        .load-more-btn:hover {
            background: var(--black);
            color: var(--white);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
        <div class="loading-text">loading dream lexicon...</div>
        <div class="loading-stats">
            <div class="loading-stat">
                <span class="loading-stat-value" id="loadingPatterns">0</span>
                <span class="loading-stat-label">patterns loaded</span>
            </div>
            <div class="loading-stat">
                <span class="loading-stat-value" id="loadingDreams">0</span>
                <span class="loading-stat-label">dreams indexed</span>
            </div>
        </div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
    </div>
    
    <div class="header">
        <div class="header-top">
            <div class="logo">Dream Lexicon</div>
            <div class="header-stats">
                <span>patterns <span class="stat-value" id="total-patterns">—</span></span>
                <span>dreams <span class="stat-value" id="total-dreams">—</span></span>
            </div>
            <a href="poetry.html" class="poetry-btn">make your own fridge poetry</a>
        </div>
        <div class="universal-controls">
            <div class="search-container">
                <input type="text" class="universal-search" placeholder="Search all patterns..." id="universal-search">
            </div>
            <div class="sort-controls">
                <span class="sort-label">Sort</span>
                <button class="universal-sort-btn active" data-sort="alpha">A–Z</button>
                <button class="universal-sort-btn" data-sort="freq">Frequency</button>
            </div>
        </div>
    </div>

    <div class="columns-container">
        <div class="column" data-pattern="adj_noun">
            <div class="column-header">
                <div class="column-title">Adj–Noun</div>
                <div class="column-count" id="count-adj_noun">—</div>
            </div>
            <div class="items-list" id="list-adj_noun"></div>
            <div class="dreams-view" id="dreams-adj_noun"></div>
        </div>

        <div class="column" data-pattern="verb_noun">
            <div class="column-header">
                <div class="column-title">Verb–Noun</div>
                <div class="column-count" id="count-verb_noun">—</div>
            </div>
            <div class="items-list" id="list-verb_noun"></div>
            <div class="dreams-view" id="dreams-verb_noun"></div>
        </div>

        <div class="column" data-pattern="prep">
            <div class="column-header">
                <div class="column-title">Prepositional</div>
                <div class="column-count" id="count-prep">—</div>
            </div>
            <div class="items-list" id="list-prep"></div>
            <div class="dreams-view" id="dreams-prep"></div>
        </div>

        <div class="column" data-pattern="adverb_verb">
            <div class="column-header">
                <div class="column-title">Adverb–Verb</div>
                <div class="column-count" id="count-adverb_verb">—</div>
            </div>
            <div class="items-list" id="list-adverb_verb"></div>
            <div class="dreams-view" id="dreams-adverb_verb"></div>
        </div>

        <div class="column" data-pattern="temporal">
            <div class="column-header">
                <div class="column-title">Temporal</div>
                <div class="column-count" id="count-temporal">—</div>
            </div>
            <div class="items-list" id="list-temporal"></div>
            <div class="dreams-view" id="dreams-temporal"></div>
        </div>

        <div class="column" data-pattern="compound">
            <div class="column-header">
                <div class="column-title">Compound</div>
                <div class="column-count" id="count-compound">—</div>
            </div>
            <div class="items-list" id="list-compound"></div>
            <div class="dreams-view" id="dreams-compound"></div>
        </div>

        <div class="column" data-pattern="emotional">
            <div class="column-header">
                <div class="column-title">Emotional</div>
                <div class="column-count" id="count-emotional">—</div>
            </div>
            <div class="items-list" id="list-emotional"></div>
            <div class="dreams-view" id="dreams-emotional"></div>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ======= CONFIGURATION =======
        // Replace these with your Supabase project credentials
        const SUPABASE_URL = 'https://ldpxwjzqaraehwvybiqe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkcHh3anpxYXJhZWh3dnliaXFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODEwMDAsImV4cCI6MjA4MDM1NzAwMH0.9N7ml2HWY0I3KZ4PEGoyCqnMKRJGzYUcX6g_HuBwIgU';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ======= STATE =======
        const ITEMS_PER_PAGE = 5000; // Load in chunks for infinite scroll
        let universalSort = 'alpha';
        let universalSearch = '';
        let blacklist = {
            adj_noun: new Set(),
            verb_noun: new Set(),
            prep: new Set(),
            adverb_verb: new Set(),
            temporal: new Set(),
            compound: new Set(),
            emotional: new Set()
        };
        
        let loadingStats = {
            actualPatterns: 0,
            actualDreams: 0,
            columnsLoaded: 0,
            totalColumns: 7,
            animationComplete: false,
            dataLoaded: false
        };

        function startLoadingAnimation(estimatedPatterns, estimatedDreams, duration = 3000) {
            const startTime = performance.now();
            
            const patternsEl = document.getElementById('loadingPatterns');
            const dreamsEl = document.getElementById('loadingDreams');
            const progressBar = document.getElementById('loadingProgressBar');
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutCubic(progress);
                
                // Animate patterns count
                if (patternsEl) {
                    const currentPatterns = Math.floor(estimatedPatterns * easedProgress);
                    patternsEl.textContent = currentPatterns.toLocaleString();
                }
                
                // Animate dreams count
                if (dreamsEl) {
                    const currentDreams = Math.floor(estimatedDreams * easedProgress);
                    dreamsEl.textContent = currentDreams.toLocaleString();
                }
                
                // Animate progress bar
                if (progressBar) {
                    progressBar.style.width = (easedProgress * 100) + '%';
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    loadingStats.animationComplete = true;
                    checkLoadingComplete();
                }
            }
            
            requestAnimationFrame(animate);
        }

        function checkLoadingComplete() {
            if (loadingStats.animationComplete) {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }
        }

        function updateActualLoadingStats(patterns) {
            loadingStats.actualPatterns += patterns;
            loadingStats.columnsLoaded++;
        }

        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        function animateNumber(element, start, end, duration) {
            const startTime = performance.now();
            const diff = end - start;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutCubic(progress);
                const current = Math.floor(start + diff * easedProgress);
                element.textContent = current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.textContent = end.toLocaleString();
                }
            }
            
            requestAnimationFrame(update);
        }
        
        let columnData = {
            adj_noun: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            verb_noun: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            prep: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            adverb_verb: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            temporal: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            compound: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 },
            emotional: { loaded: false, hasMore: true, offset: 0, patterns: [], loading: false, lastRendered: 0 }
        };

        // ======= BLACKLIST =======
        // Embedded permanent blacklist
        const EMBEDDED_BLACKLIST = {"adj_noun":["2nd bag","2nd choice","2nd elevator","2nd row","3rd person","8th floor","_ dollars","_ tank","--then baby","-action","-circle","-country","-de","-disc","-dressing","-five men","-golf","-haul","-like look","-office","-school","-smoking","-state","-truck","-year","! tat","'social modeling","*calypso","° movement","+ feeling","~2 inch","100th floor","100th percentile","10th century","10th day","10th floor","10th grade","10th tickets","11th floor","11th grade","11th level","11th story","11th street","12th grade","12th level","12th man","12th night","12th year","13th floor","14th floor","14th level","14th street","15th birthday","15th century","15th floor","16th century","16th floor","16th note","16th notes","16th room","17th birthday","17th century","18th birthday","18th century","190ng bamboo","19th birthday","19th century","1st base","1st class","1st dream","1st floor","1st grade","1st level","1st man","1st nurse","1st one","1st parking","1st part","1st person","1st question","1st race","1st room","1st slip","1st story","1st strip","1st violin","1st wife","1st year","20th century","20th floor","21st story","25th anniversary","25th floor","25th wedding","27th century","2nd baby","2nd balcony","2nd class","2nd dream","2nd flight","2nd floor","2nd gear","2nd girl","2nd glass","2nd grade","2nd healing","2nd horse","2nd house","2nd kind","2nd lady","2nd man","2nd meeting","2nd part","2nd quarter","2nd race","2nd room","2nd shift","2nd story","2nd street","2nd thing","2nd time","2nd trimester","2nd wife","2nd woman","2nd year","30ish woman","32nd floor","38th street","39th street","3d bar","3d effects","a+ +"],"verb_noun":["---a large platter","--see a black cat","--to my horror","= a good friend","= an acquaintence","= an aquaintance","= an older cousin","= good friend","= my best friend","= my hometown","­ the same one"],"prep":["---for shore","'cause the","'s she's learned from","@ $5","@ $5.98","@ 90 m.p.h","@ a scene","++ feeling","= throne","a guy i am with","about _"],"adverb_verb":["'s also","'s dirt here","'s maybe","'s rather","a********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************ht add","--also see","--can't recall","--literally manicuring","'d better","'d rather","'quite","'s actually","'s already","'s always","'s another, though","'s apparently","'s barely","'s hardly","'s just","'s light now","'s literally","'s mainly","'s mostly","'s nobody around","'s nobody here","'s normally","'s not actually","'s not even","'s not really","'s not still","'s now","'s nowhere","'s nowhere here","'s others here","'s out","'s so","'s still","'s stuff everywhere","'s tv around","++ feeling","aand lovingly","about based","about finished","about got","about made","about see","about as harried","abandon her too","abandoning them there","abducted too","aboard, someone tells","above-mentioned","above, there were"],"temporal":["-","'","05","09","10","11","12","17","18","20","24","27","3","2nd","30","4","5","8","a","a 7-11","80 in","_","-8:00","-full of",",",".","...","'s","'s in","\"","(",")","/","&","#","+","+ 28","0","003","004","01","01-01","01-02","01-03","01-04","01-05","01-06","01-07","01-08","01-09","01-10","01-11","01-12","01-13","01-14","01-15","01-16","01-17","01-18","01-19","01-20","01-21","01-22","01-23","01-24","01-25","01-26","01-27","01-28","01-29","01-30","01-31","01/06/48","01/13/48","01/15/48","01/20/2004","01/20/97","01/26/48","010","014","015","018","02","02 (12","02-01","02-02","02-03","02-04","02-05","02-06","02-07","02-08","02-09","02-10","02-11","02-12","02-13","02-14","02-15","02-16","02-17","02-18","02-19","02-20","02-21","02-22","02-23","02-24","02-25","02-26","02-27","02-28","02-29","02/01/48","02/10/47","02/10/48","02/14/48","02/17/47","02/18/48","02/19/47","02/21/48","02/22/47","02/28/48","020","03","03-01","03-02","03-03","03-04","03-05","03-06","03-07","03-08","03-09","03-10","03-11","03-12","03-13","03-14","03-15","03-16","03-17","03-18","03-19","03-20","03-21","03-22","03-23","03-24","03-25","03-26","a '","age","age 10","age 11","age 12","age 13","age 14","age 15","age 16","age 17","age 18","age 19","age 19, 04/??/48","age 19, 06/??/47","age 2","age 20","age 20, 01/??/48","age 20, 04/??/47","age 20, 10/??/46","age 20, 10/??/47","age 20, 12/??/47","age 20, 12/29/47","age 21","age 21, 01/??/47","age 21, 01/??/48","age 21, 03/06/4","age 21, 03/08/4","age 21, 03/26/4","age 21, 06/??/46","age 21, 06/26/4","age 21, 10/??/47","age 21, 10/??/49","age 21, 11/??/47","age 21, 12/??/47","age 21, 12/29/47","age 22","age 22, 05/14/4","age 22, 05/22/4","age 22, 05/24/4","age 22, 07/06/4","age 23","age 24","age 24, 10/??/47","age 24, 11/??/47","age 25","age 26","age 30","age 32","age 39 from","age 4","age 40","age 44","age 45","age 47","age 5","age 50","age 55","age 6","age 69","age 7","age 80","age 9","age thirty","ages","ages 11","ages 12","ages 16","ages 19","ages 45","a 1 year old","a 1 yr old","a 1:00 am lab","a 1/2 hour","a 10-year-old","a 12 year old","a 12 years","a 12-year-old","a 13 year old","a 14 year old","a 14-year-old","a 15 hour day","a 15 year old","a 16-year-old","a 1930","a 1950","a 1950s","a 1975","a 2 year","a 2-year","a 20 year","a 2nd quarter","a 3 day weekend","a 3 year","a 3-year old","a 30-30","a 4-year old","a 4-year-old","a 5-year-old","a 54","a 7","a 7 year old","a 8-5","a 9-year old girl","a b'day","inch","ish","jack","jan","jan.","jan. 18","jan. 23","jan. 31","january","january 1","january 1, 1966","january 11","january 15, 1998","in their late 20's","january 28, 1998","january 27","january 25 1979","january 25","january 21, 1998","january 21, 1982","january 2, 1979","january 19, 1982","january 8","january 5, 1998","her","high","high school","his","holiday","holidays","horrible","i","illuminated","im","important","in","jizz","judgement","judgement day","july","july 10, 2000","july 12, 1977","july 15","july 15, 1941","july 17, 1981","july 17, 1982","july 19, 1981","july 2","july 20","july 2003","july 23, 1980","july 27, 1981","july 28, 1981","july 3, 1977","july 3, 1981","july 31, 1998","july 4, 1981","june 3, 1999","june 27, 1971","june 24, 1981","june 21","june 16, 1970","june 15, 1981","june 1","june","july of","july 8","july 5"],"compound":["-clockwise","-height","-lovers","-muck","-streets","-thing","-turn","-type","-workers","1st row","_ building","_ car","_ gift","_ parking","_ pill","_ schedule","_ thing","_ years",": style","?buggies",". fence",". height",". man",". night",". table",". woman","..brother",".the girls","'50s","'60s","'80s","'ants","'omg","* body","*love","*shrug","*size","/desk","# a","# cross","% auto","% commission","% discount","% human","% interest","% match","% nonfat","% pc","% princess","% tip","° angle","°c","+ r","++","= acquaintence","= ex","= f","= friend","= friends","= guy","= sister","=_","a batteries","a-- building","a. building","a. feeling","a. m.","a dream","a team","a. man","a. sleeps","a.m. class","a.m. weather","ab roller"],"emotional":[]};

        async function loadBlacklist() {
            // Load embedded permanent blacklist
            Object.keys(EMBEDDED_BLACKLIST).forEach(pattern => {
                EMBEDDED_BLACKLIST[pattern].forEach(phrase => blacklist[pattern].add(phrase.toLowerCase()));
            });
            
            // Also load from localStorage for additional user-hidden items
            const stored = localStorage.getItem('dreambank_blacklist');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    Object.keys(parsed).forEach(pattern => {
                        parsed[pattern].forEach(phrase => blacklist[pattern].add(phrase.toLowerCase()));
                    });
                } catch (e) {
                    console.error('Error loading localStorage blacklist:', e);
                }
            }
        }

        function hideItem(pattern, phrase) {
            blacklist[pattern].add(phrase.toLowerCase());
            
            const blacklistObj = {};
            Object.keys(blacklist).forEach(p => {
                blacklistObj[p] = Array.from(blacklist[p]);
            });
            localStorage.setItem('dreambank_blacklist', JSON.stringify(blacklistObj));
            
            // Remove from DOM
            const listEl = document.getElementById(`list-${pattern}`);
            const items = listEl.querySelectorAll('.item');
            items.forEach(item => {
                if (item.querySelector('.item-text').textContent.toLowerCase() === phrase.toLowerCase()) {
                    item.remove();
                }
            });
        }

        // ======= SUPABASE QUERIES =======
        async function getTotalDreamsCount() {
            const { count, error } = await supabase
                .from('dreams')
                .select('*', { count: 'exact', head: true });
            
            if (error) {
                console.error('Error fetching dreams count:', error);
                return 0;
            }
            return count;
        }

        async function getPatternsByType(patternType, sortBy = 'alpha', searchQuery = '') {
            // Use the fast pattern_counts materialized view
            // Aggregate as we load to avoid stack overflow
            const aggregated = new Map();
            let page = 0;
            const pageSize = 1000;
            const maxPages = 100; // Reasonable limit (100K rows max)
            let totalRows = 0;
            
            while (page < maxPages) {
                try {
                    let query = supabase
                        .from('pattern_counts')
                        .select('text_lower, display_text, count')
                    .eq('pattern_type', patternType)
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                    const { data, error } = await query;
                    
                if (error) {
                        console.error(`Error fetching ${patternType} page ${page}:`, error);
                        if (page === 0) throw error;
                    break;
                }
                
                if (!data || data.length === 0) break;
                    
                    // Process and aggregate immediately to avoid memory issues
            data.forEach(row => {
                        const text = row.text_lower;
                // Skip if starts with number or dash
                if (/^[0-9-]/.test(text)) return;
                // Skip if blacklisted
                if (blacklist[patternType].has(text)) return;
                // Skip if doesn't match search
                if (searchQuery && !text.includes(searchQuery.toLowerCase())) return;
                
                        if (aggregated.has(text)) {
                            aggregated.get(text).count += row.count;
                        } else {
                            aggregated.set(text, {
                                text: row.display_text,
                                count: row.count
                            });
                        }
                    });
                    
                    totalRows += data.length;
                    if (data.length < pageSize) break;
                    page++;
                } catch (err) {
                    console.error(`Exception loading ${patternType} page ${page}:`, err);
                    if (page === 0) throw err;
                    break;
                }
            }
            
            if (aggregated.size === 0) {
                console.warn('No data fetched for pattern type:', patternType);
                return { results: [], total: 0 };
            }
            
            // Convert to array
            let results = Array.from(aggregated.values());
            
            // Sort
            if (sortBy === 'freq') {
                results.sort((a, b) => b.count - a.count || a.text.localeCompare(b.text));
            } else {
                results.sort((a, b) => a.text.localeCompare(b.text));
            }
            
            const total = results.length;
            
            // Return all results
            return { results: results, total };
        }

        async function getTotalPatternCount(patternType) {
            // Query patterns table directly
            const { data, error } = await supabase
                .from('patterns')
                .select('text', { count: 'exact', head: false })
                .eq('pattern_type', patternType);
            
            if (error) {
                console.error('Error fetching pattern count:', error);
                return 0;
            }
            
            // Count unique texts
            const uniqueTexts = new Set(data.map(p => p.text));
            return uniqueTexts.size;
        }

        async function getDreamsByPattern(patternType, phrase, limit = 100) {
            const { data, error } = await supabase
                .from('patterns')
                .select(`
                    dream_id,
                    start_pos,
                    end_pos,
                    dreams (
                        id,
                        text
                    )
                `)
                .eq('pattern_type', patternType)
                .ilike('text', phrase)
                .limit(limit);
            
            if (error) {
                console.error('Error fetching dreams:', error);
                return [];
            }
            
            // Transform to expected format
            return data.map(row => ({
                id: row.dreams.id,
                text: row.dreams.text,
                start_pos: row.start_pos,
                end_pos: row.end_pos
            }));
        }

        // ======= RENDERING =======
        async function loadColumn(pattern, append = false) {
            const listEl = document.getElementById(`list-${pattern}`);
            
            if (!append) {
                listEl.innerHTML = '<div class="loading-indicator">Loading patterns...</div>';
                columnData[pattern].offset = 0;
                columnData[pattern].patterns = [];
                columnData[pattern].hasMore = true;
            }
            
            try {
                const { results, total } = await getPatternsByType(
                    pattern, 
                    universalSort, 
                    universalSearch, 
                    ITEMS_PER_PAGE, 
                    columnData[pattern].offset
                );
                
                columnData[pattern].patterns.push(...results);
                columnData[pattern].offset += results.length;
                columnData[pattern].hasMore = results.length === ITEMS_PER_PAGE;
                columnData[pattern].loaded = true;
                columnData[pattern].loading = false;
                columnData[pattern].total = total;
                
                renderPatternList(pattern, columnData[pattern].patterns, append);
                
                // Update count with total filtered count
                document.getElementById(`count-${pattern}`).textContent = total.toLocaleString();
                
                // Update loading stats during initial load
                if (!append && document.getElementById('loadingOverlay') && !document.getElementById('loadingOverlay').classList.contains('hidden')) {
                    updateActualLoadingStats(total);
                }
            } catch (error) {
                console.error(`Error loading column ${pattern}:`, error);
                console.error('Error details:', error.message, error.stack);
                listEl.innerHTML = `<div class="loading-indicator">Error loading patterns: ${error.message || 'Unknown error'}</div>`;
            }
        }

        function renderPatternList(pattern, patterns, append = false) {
            const listEl = document.getElementById(`list-${pattern}`);
            
            if (!append) {
                listEl.innerHTML = '';
                
                // Set up scroll listener once
                if (!listEl._scrollHandler) {
                    listEl._scrollHandler = () => {
                        const scrollBottom = listEl.scrollTop + listEl.clientHeight;
                        const threshold = listEl.scrollHeight - 100;
                        
                        if (scrollBottom >= threshold && columnData[pattern].hasMore && !columnData[pattern].loading) {
                            columnData[pattern].loading = true;
                            
                            // Load more from already-fetched data
                            setTimeout(() => {
                                loadColumn(pattern, true);
                            }, 100);
                        }
                    };
                    listEl.addEventListener('scroll', listEl._scrollHandler);
                }
            } else {
                // Remove the old load more button
                const oldBtn = listEl.querySelector('button');
                if (oldBtn) oldBtn.remove();
            }
            
            // Determine which patterns to render
            const startIdx = append ? columnData[pattern].lastRendered || 0 : 0;
            const patternsToRender = patterns.slice(startIdx);
            
            patternsToRender.forEach(({ text, count }) => {
                const div = document.createElement('div');
                div.className = 'item';
                
                const innerDiv = document.createElement('div');
                innerDiv.className = 'item-inner';
                
                const textEl = document.createElement('div');
                textEl.className = 'item-text';
                textEl.textContent = text;
                
                const countEl = document.createElement('div');
                countEl.className = 'item-count';
                countEl.textContent = count;
                
                innerDiv.appendChild(textEl);
                innerDiv.appendChild(countEl);
                
                div.appendChild(innerDiv);
                
                div.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const anyExpanded = document.querySelector('.column.expanded');
                    if (anyExpanded) {
                        collapseAll();
                        setTimeout(() => expandColumn(pattern, text), 50);
                    } else {
                        expandColumn(pattern, text);
                    }
                });
                
                listEl.appendChild(div);
            });
            
            columnData[pattern].lastRendered = patterns.length;
            columnData[pattern].hasMore = false; // All patterns are loaded now
        }

        async function loadAllColumns() {
            const patterns = ['adj_noun', 'verb_noun', 'prep', 'adverb_verb', 'temporal', 'compound', 'emotional'];
            
            // Start animation immediately with estimates
            let estimatedPatterns = 306942;
            let estimatedDreams = 38194;
            
            // Start smooth animation right away
            startLoadingAnimation(estimatedPatterns, estimatedDreams, 4000);
            
            // Set the pattern count in header (hardcoded - actual count from database)
            document.getElementById('total-patterns').textContent = estimatedPatterns.toLocaleString();
            
            // Fetch dream count (non-blocking)
            supabase
                .from('dreams')
                .select('*', { count: 'exact', head: true })
                .then(({ count }) => {
                    if (count) {
                        document.getElementById('total-dreams').textContent = count.toLocaleString();
                    }
                })
                .catch(err => console.error('Error fetching dream count:', err));
            
            // Load all columns
            await Promise.all(patterns.map(p => loadColumn(p)));
            
            // Mark data as loaded
            loadingStats.dataLoaded = true;
            checkLoadingComplete();
        }

        function collapseAll() {
            const columns = document.querySelectorAll('.column');
            columns.forEach(col => {
                col.classList.remove('expanded', 'collapsed', 'active');
            });
        }

        async function expandColumn(pattern, selectedItem) {
            const columns = document.querySelectorAll('.column');
            const selectedColumn = document.querySelector(`.column[data-pattern="${pattern}"]`);
            
            columns.forEach(col => {
                col.classList.remove('expanded', 'active');
                col.classList.add('collapsed');
            });
            
            selectedColumn.classList.remove('collapsed');
            selectedColumn.classList.add('expanded', 'active');
            
            await displayDreams(pattern, selectedItem);
        }

        async function displayDreams(pattern, phrase) {
            const viewEl = document.getElementById(`dreams-${pattern}`);
            viewEl.innerHTML = '<div class="loading-indicator">Loading dreams...</div>';
            
            try {
                const dreams = await getDreamsByPattern(pattern, phrase);
                
                let html = `
                    <div class="back-button" onclick="collapseAll()">← back to all columns</div>
                    <div class="dreams-header">
                        <div class="selected-phrase">${escapeHtml(phrase)}</div>
                        <div class="dreams-meta">${dreams.length} DREAM${dreams.length !== 1 ? 'S' : ''}</div>
                    </div>
                `;
                
                dreams.forEach(dream => {
                    const highlighted = highlightPhrase(dream.text, phrase);
                    html += `
                        <div class="dream-card">
                            <div class="dream-card-header">
                                <span class="dream-label">Dream</span>
                                <span class="dream-id">#${(dream.id + 1).toString().padStart(5, '0')}</span>
                            </div>
                            <div class="dream-text">${highlighted}</div>
                        </div>
                    `;
                });
                
                viewEl.innerHTML = html;
                viewEl.scrollTop = 0;
            } catch (error) {
                console.error('Error displaying dreams:', error);
                viewEl.innerHTML = '<div class="loading-indicator">Error loading dreams</div>';
            }
        }

        function highlightPhrase(text, phrase) {
            const escaped = escapeHtml(text);
            const lower = text.toLowerCase();
            const lowerPhrase = phrase.toLowerCase();
            const parts = [];
            let lastIdx = 0;
            let idx = lower.indexOf(lowerPhrase);
            
            while (idx !== -1) {
                if (idx > lastIdx) parts.push(escaped.substring(lastIdx, idx));
                const match = text.substring(idx, idx + phrase.length);
                parts.push(`<span class="highlight">${escapeHtml(match)}</span>`);
                lastIdx = idx + phrase.length;
                idx = lower.indexOf(lowerPhrase, lastIdx);
            }
            
            if (lastIdx < escaped.length) parts.push(escaped.substring(lastIdx));
            return parts.join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ======= EVENT HANDLERS =======
        document.querySelectorAll('.column-header').forEach(header => {
            header.addEventListener('click', function(e) {
                const anyExpanded = document.querySelector('.column.expanded');
                if (anyExpanded) {
                    collapseAll();
                }
            });
        });

        document.getElementById('universal-search').addEventListener('input', function(e) {
            const anyExpanded = document.querySelector('.column.expanded');
            if (anyExpanded) {
                collapseAll();
            }
            universalSearch = e.target.value;
            // Reload all columns with search
            Object.keys(columnData).forEach(pattern => {
                columnData[pattern].loaded = false;
                columnData[pattern].offset = 0;
                columnData[pattern].patterns = [];
                columnData[pattern].hasMore = true;
            });
            loadAllColumns();
        });

        document.querySelectorAll('.universal-sort-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const anyExpanded = document.querySelector('.column.expanded');
                if (anyExpanded) {
                    collapseAll();
                }
                universalSort = this.dataset.sort;
                document.querySelectorAll('.universal-sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                // Reload all columns with new sort
                Object.keys(columnData).forEach(pattern => {
                    columnData[pattern].loaded = false;
                    columnData[pattern].offset = 0;
                    columnData[pattern].patterns = [];
                    columnData[pattern].hasMore = true;
                });
                loadAllColumns();
            });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                collapseAll();
            }
        });

        // Export blacklist to save permanently
        window.exportBlacklist = function() {
            const stored = localStorage.getItem('dreambank_blacklist');
            if (!stored) {
                return;
            }
            
            const parsed = JSON.parse(stored);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(JSON.stringify(parsed, null, 2));
            }
            
            return parsed;
        };

        window.showBlacklistStats = function() {
            const stored = localStorage.getItem('dreambank_blacklist');
            if (!stored) {
                return;
            }
            
            const parsed = JSON.parse(stored);
            return parsed;
        };

        // ======= INITIALIZATION =======
        async function init() {
            // Check if Supabase is configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                alert('Please configure your Supabase credentials in the HTML file. See the README for instructions.');
                return;
            }
            
            await loadBlacklist();
            
            // Load all columns (this will set the counts)
            await loadAllColumns();
        }

        // Start the app
        init().catch(error => {
            console.error('Error initializing app:', error);
            alert('Error connecting to database. Please check your Supabase configuration and console for details.');
        });
    </script>
</body>
</html>

